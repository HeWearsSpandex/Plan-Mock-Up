<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Freehand Paintbrush Annotation with Zoom</title>
  <script src="https://unpkg.com/konva@8.3.5/konva.min.js"></script>
  <style>
    html, body { margin: 0; padding: 0; height: 100%; overflow: hidden; }
    body { font-family: sans-serif; padding: 10px; box-sizing: border-box; }
    #controls { margin-bottom: 10px; display: flex; flex-wrap: wrap; gap: 10px; align-items: center; }
    #controls input, #controls select, #controls button { padding: 6px; }
    #toggles label { margin-right: 10px; }
    #stage-container { border: 1px solid #ccc; width: 100vw; height: calc(100vh - 100px); touch-action: none; user-select: none; }
  </style>
</head>
<body>
  <div id="controls">
    <input type="file" id="bgInput" accept="image/*" />
    <input id="visitName" placeholder="Visit name (e.g. 2025-06-26)" disabled />
    <select id="visitType" disabled>
      <option value="">Select polygon type</option>
      <option value="Scabbling">Scabbling</option>
      <option value="Hydroblast">Hydroblast</option>
      <option value="Line Marking">Line Marking</option>
      <option value="Sweeping">Sweeping</option>
      <option value="Internal">Internal</option>
    </select>
    <button id="newVisit" disabled>New Visit Layer</button>
    <button id="deleteLayer" disabled>Delete Layer</button>
    <label>Color: <input type="color" id="colorPicker" value="#ff0000" /></label>
    <label>Brush size: <input type="number" id="brushSize" value="30" min="1" max="200" style="width:60px;" /></label>
    <button id="clearLayer" disabled>Clear Layer</button>
    <button id="zoomIn">Zoom In</button>
    <button id="zoomOut">Zoom Out</button>
    <label>Zoom: <input type="range" id="zoomSlider" min="0.5" max="2" step="0.1" value="1" /></label>
    <div id="toggles"></div>
  </div>
  <div id="stage-container"></div>

  <script>
    // Setup Konva stage and layers
    const container = document.getElementById('stage-container');
    const width = container.clientWidth;
    const height = container.clientHeight;
    const stage = new Konva.Stage({ container: 'stage-container', width, height });
    const bgLayer = new Konva.Layer();
    stage.add(bgLayer);

    let bgImage;
    const visits = {};
    let activeLayer = null;
    let drawing = false;
    let scale = 1;

    // Controls
    const newVisitBtn = document.getElementById('newVisit');
    const deleteLayerBtn = document.getElementById('deleteLayer');
    const clearLayerBtn = document.getElementById('clearLayer');
    const zoomInBtn = document.getElementById('zoomIn');
    const zoomOutBtn = document.getElementById('zoomOut');
    const zoomSlider = document.getElementById('zoomSlider');

    // Helper: redraw stage scale
    function setScale(newScale) {
      scale = newScale;
      stage.scale({ x: scale, y: scale });
      stage.batchDraw();
      zoomSlider.value = scale.toFixed(1);
    }

    // Zoom controls
    zoomInBtn.addEventListener('click', () => setScale(Math.min(scale + 0.1, 2)));
    zoomOutBtn.addEventListener('click', () => setScale(Math.max(scale - 0.1, 0.5)));
    zoomSlider.addEventListener('input', e => setScale(parseFloat(e.target.value)));

    // Load background image
    document.getElementById('bgInput').addEventListener('change', e => {
      const file = e.target.files[0]; if (!file) return;
      const reader = new FileReader();
      reader.onload = evt => {
        const imgObj = new Image(); imgObj.src = evt.target.result;
        imgObj.onload = () => {
          bgLayer.destroyChildren();
          bgImage = new Konva.Image({ image: imgObj, width, height, listening: false });
          bgLayer.add(bgImage);
          stage.batchDraw();
          // enable visit inputs
          document.getElementById('visitName').disabled = false;
          document.getElementById('visitType').disabled = false;
          newVisitBtn.disabled = false;
        };
      };
      reader.readAsDataURL(file);
    });

    // Create new annotation layer
    newVisitBtn.addEventListener('click', () => {
      const nameInput = document.getElementById('visitName');
      const typeSelect = document.getElementById('visitType');
      const name = nameInput.value.trim();
      const type = typeSelect.value;
      if (!name) return alert('Enter visit name');
      if (!type) return alert('Select polygon type');
      const layerKey = `${name} [${type}]`;
      if (visits[layerKey]) return alert('Layer exists for this visit and type');
      const layer = new Konva.Layer({ name: layerKey });
      stage.add(layer);
      visits[layerKey] = layer;
      activeLayer = layer;
      addToggle(layerKey);
      clearLayerBtn.disabled = false;
      deleteLayerBtn.disabled = false;
      nameInput.value = '';
      typeSelect.value = '';
    });

    // Delete current layer
    deleteLayerBtn.addEventListener('click', () => {
      if (!activeLayer) return;
      const name = activeLayer.name();
      // remove layer
      activeLayer.destroy();
      delete visits[name];
      // remove toggle
      const lbl = document.getElementById(`lbl_${name}`);
      if (lbl) lbl.parentNode.removeChild(lbl);
      stage.batchDraw();
      // reset activeLayer
      const keys = Object.keys(visits);
      if (keys.length) {
        activeLayer = visits[keys[keys.length - 1]];
      } else {
        activeLayer = null;
        clearLayerBtn.disabled = true;
        deleteLayerBtn.disabled = true;
      }
    });

    // Add toggle checkbox
    function addToggle(name) {
      const cont = document.getElementById('toggles');
      const chk = document.createElement('input'); chk.type = 'checkbox'; chk.id = `chk_${name}`; chk.checked = true;
      chk.onchange = () => { visits[name].visible(chk.checked); stage.batchDraw(); };
      const lbl = document.createElement('label'); lbl.htmlFor = chk.id; lbl.id = `lbl_${name}`;
      lbl.appendChild(chk); lbl.appendChild(document.createTextNode(' ' + name));
      cont.appendChild(lbl);
    }

    // Drawing events
    stage.on('mousedown touchstart', () => {
      if (!activeLayer || !bgImage) return;
      drawing = true; drawPoint();
    });
    stage.on('mousemove touchmove', () => { if (drawing) drawPoint(); });
    stage.on('mouseup touchend', () => { drawing = false; });

    function drawPoint() {
      const pos = stage.getPointerPosition();
      const color = document.getElementById('colorPicker').value;
      const size = parseInt(document.getElementById('brushSize').value, 10);
      const circle = new Konva.Circle({ x: pos.x, y: pos.y, radius: size / 2, fill: color, listening: false });
      activeLayer.add(circle);
      stage.batchDraw();
    }

    // Clear layer
    clearLayerBtn.addEventListener('click', () => {
      if (activeLayer) { activeLayer.destroyChildren(); stage.batchDraw(); }
    });

    // Initialize scale slider value
    setScale(1);
  </script>
</body>
</html>
