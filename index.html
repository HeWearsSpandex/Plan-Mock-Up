<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Freehand Paintbrush Annotation with Layer Opacity</title>
  <script src="https://unpkg.com/konva@8.3.5/konva.min.js"></script>
  <style>
    html, body { margin: 0; padding: 0; height: 100%; overflow: hidden; }
    body { font-family: sans-serif; padding: 20px; }
    #controls { margin-bottom: 10px; display: flex; gap: 12px; flex-wrap: wrap; align-items: center; }
    #controls input, #controls button { padding: 6px; }
    #toggles label { margin-right: 10px; }
    #container {
      border: 1px solid #ccc;
      width: 1600px;
      height: 900px;
      cursor: crosshair;
      touch-action: none;          /* prevent default touch scrolling/panning */
      overscroll-behavior: contain; /* contain touch behavior inside canvas */
      -ms-touch-action: none;
      user-select: none;
      -webkit-user-select: none;
    }
  </style>
</head>
<body>
  <div id="controls">
    <input type="file" id="bgInput" accept="image/*" />
    <input id="visitName" placeholder="Visit name (e.g. 2025-06-26)" disabled />
    <button id="newVisit" disabled>New Visit Layer</button>
    <label>Color: <input type="color" id="colorPicker" value="#ff0000" /></label>
    <label>Brush size: <input type="number" id="brushSize" value="30" min="1" max="200" style="width:60px;" /></label>
    <label>Opacity: <input type="range" id="opacityPicker" min="0.1" max="1" step="0.1" value="0.5" /></label>
    <button id="clearLayer" disabled>Clear Layer</button>
    <div id="toggles"></div>
  </div>
  <div id="container"></div>

  <script>
    const canvasW = 1600, canvasH = 900;
    // prevent mobile scroll
    document.body.addEventListener('touchmove', e => { e.preventDefault(); }, { passive: false });

    const stage = new Konva.Stage({ container: 'container', width: canvasW, height: canvasH });
    // disable default drag content on touch
    stage.container().style.touchAction = 'none';

    const bgLayer = new Konva.Layer();
    stage.add(bgLayer);

    let bgImage;
    const visits = {};
    let activeLayer = null;
    let drawing = false;

    // Load background
    document.getElementById('bgInput').addEventListener('change', e => {
      const file = e.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = evt => {
        const img = new Image(); img.src = evt.target.result;
        img.onload = () => {
          bgLayer.destroyChildren();
          bgImage = new Konva.Image({ image: img, width: canvasW, height: canvasH, listening: false });
          bgLayer.add(bgImage);
          stage.batchDraw();
          document.getElementById('visitName').disabled = false;
          document.getElementById('newVisit').disabled = false;
        };
      };
      reader.readAsDataURL(file);
    });

    // New layer
    document.getElementById('newVisit').addEventListener('click', () => {
      const name = document.getElementById('visitName').value.trim();
      if (!name) return alert('Enter visit name');
      if (visits[name]) return alert('Layer exists');
      const layer = new Konva.Layer({ name });
      stage.add(layer);
      visits[name] = layer;
      activeLayer = layer;
      addToggle(name);
      document.getElementById('clearLayer').disabled = false;
      document.getElementById('visitName').value = '';
    });

    // Toggle checkbox
    function addToggle(name) {
      const cont = document.getElementById('toggles');
      const chk = document.createElement('input'); chk.type = 'checkbox'; chk.id = `chk_${name}`; chk.checked = true;
      chk.onchange = () => { visits[name].visible(chk.checked); stage.batchDraw(); };
      const lbl = document.createElement('label'); lbl.htmlFor = chk.id;
      lbl.appendChild(chk); lbl.appendChild(document.createTextNode(' ' + name));
      cont.appendChild(lbl);
    }

    // Drawing
    stage.on('mousedown touchstart', () => {
      if (!activeLayer || !bgImage) return;
      drawing = true;
      drawPoint();
    });
    stage.on('mousemove touchmove', () => {
      if (!drawing) return;
      drawPoint();
    });
    stage.on('mouseup touchend', () => { drawing = false; });

    function drawPoint() {
      const pos = stage.getPointerPosition();
      const color = document.getElementById('colorPicker').value;
      const size = parseInt(document.getElementById('brushSize').value, 10);
      const opacity = parseFloat(document.getElementById('opacityPicker').value);
      const circ = new Konva.Circle({ x: pos.x, y: pos.y, radius: size/2, fill: color, opacity: opacity, listening: false });
      activeLayer.add(circ);
      activeLayer.batchDraw();
    }

    // Clear
    document.getElementById('clearLayer').addEventListener('click', () => {
      if (activeLayer) { activeLayer.destroyChildren(); stage.batchDraw(); }
    });
  </script>
</body>
</html>
